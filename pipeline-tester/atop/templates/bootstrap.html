{% load django_tables2 %}
{% load i18n %}
{% block table-wrapper %}


<script>

$(document).ready(function(){

    const DATA_FILE = 0;
    const DATA_URL = 1;
    const DATA_CARMIN = 2;
    const POST = 0;
    const GET = 1;
    const VALIDATION_SUCCESS = 0;
    const VALIDATION_FAILURE = 1;
    const MSG_STATUS_IDLE = 0;
    const MSG_STATUS_SUCCESS = 1;
    const MSG_STATUS_FAILURE = 2;

    function DataSelector(tab, fieldId, fieldId_bis, msgId, type) {
        this.that = this;
        this.tab = tab;
        this.fieldId = fieldId;
        this.hFieldId = "#" + fieldId;
        this.fieldId_bis = fieldId_bis;
        this.hFieldId_bis = "#" + fieldId_bis;
        this.msgId = msgId;
        this.hMsgId = "#" + msgId;
        this.type = type;
        this.erroneous = false;
        this.valid = false;
        var that = this;
        
        if (type == DATA_FILE) {
        
            submit = POST;

        }
        
        else {
            submit = GET;              
        }
        
        
        // Hide the message box
        $(this.hMsgId).hide();
        

        this.processData = function() {
        
            that.validate();                
            
        }
        
     
        //preprocess
        
        this.csrfSafeMethod = function(method) {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }


        this.validate = function() {
                    
            this.displayMessage(MSG_STATUS_IDLE, "Loading..");

            var csrftoken = jQuery("[name=csrfmiddlewaretoken]").val();

            ajaxRequest = {
                beforeSend: function(xhr, settings) {
                    if (!that.csrfSafeMethod(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                        //xhr.setRequestHeader("Content-Type", content.type);
                    }
                },
                url: "/validate_descriptor/",
                success: function (jsonData) {
                                 
                    if (jsonData['code'] == VALIDATION_SUCCESS) {
                        that.erroneous = false;
                        that.valid = true;
                        that.displayMessage(MSG_STATUS_SUCCESS, jsonData["message"]);
                    }
                    if (jsonData['code'] == VALIDATION_FAILURE) {
                        that.erroneous = true;
                        that.valid = false;
                        that.displayMessage(MSG_STATUS_FAILURE, jsonData["message"]);
                    }
                },
                error: function (data) {
                    alert(data);
                }
            };
            
            switch(this.type) {
                
                case DATA_FILE:
                    var input  = document.getElementById(this.fieldId);
                    var file = input.files[0];
                    ajaxRequest["type"] = "POST";
                    ajaxRequest["data"] = file;
                    ajaxRequest["processData"] = false;
                    ajaxRequest["contentType"] = false;
                    break;
                
                case DATA_URL:
                    var url = $(this.hFieldId).val();
                    ajaxRequest["type"] = "GET";
                    ajaxRequest["data"] = {'type': DATA_URL, 'url': url};
                    ajaxRequest["processData"] = true;
                    //ajaxRequest["contentType"] = false;
                    break;
                
                case DATA_CARMIN:
                    var url  = $(this.hFieldId).val();
                    var apikey  = $(this.hFieldId_bis).val();
                    ajaxRequest["type"] = "GET";
                    ajaxRequest["data"] = {'type': DATA_CARMIN,'url': url, 'apikey': apikey};
                    ajaxRequest["processData"] = true;
                    break;
            
            }

            $.ajax(ajaxRequest);         
        }
        
        this.submit = function() {
            
            if (this.type == DATA_CARMIN) {
                
                var url = document.getElementById(this.fieldId);
                var apikey = document.getElementById(this.fieldId_bis);
                
                if (!(url && url.value)) {
                    this.displayMessage(MSG_STATUS_FAILURE, "Please provide an URL ponting to a CARMIN platform");
                    return false;
                }
                
                if (!(apikey && apikey.value)) {
                    this.displayMessage(MSG_STATUS_FAILURE, "Please provide an API key to authenticate on the associated CARMIN platform");
                    return false;
                }
            
            }
            
            else {
            
                // Check if the field has data in it.
                var myInput = document.getElementById(this.fieldId);
                if (!(myInput && myInput.value)) {
                    this.displayMessage(MSG_STATUS_FAILURE, "Please provide a descriptor");
                    return false;
                }
                
            }
            
            // Check that we do not have any errors associated with the data.
            if (this.erroneous || !this.valid) {
                            alert(this.valid);
                return false;
            }
            
            // Submission can proceed.
            alert("REACHED");
            // Indicate that this tab should be the one to process
            $('<input />').attr('type', 'hidden')
               .attr('name', "data_selector")
               .attr('value', type)
               .attr('id', "id_data_selector")
               .appendTo('#form1');
            
            return true;
            
        };
                
        
        this.reset = function() {
            
            this.erroneous = false;
            this.valid = false;
            $(this.hMsgId).hide();

        }

        this.displayMessage = function(status, message) {
            
            var msg = document.getElementById(this.msgId);

            switch(status) {
                case MSG_STATUS_IDLE:
                    msg.className = "alert alert-secondary";
                    break;
                    
                 case MSG_STATUS_SUCCESS:
                     msg.className = "alert alert-success";
                     break;
                     
                 case MSG_STATUS_FAILURE:
                    msg.className = "alert alert-danger";
                    break;
            }

            $(this.hMsgId).html(message);

            if ($(this.hMsgId).is(":visible") == false) {
                $(this.hMsgId).show();
            };

        }
        
    }

    
    var dataFile = new DataSelector("tabs-1", "id_data_file", null, "msg_file", DATA_FILE);
    var dataURL = new DataSelector("tabs-2", "id_data_url", null, "msg_url", DATA_URL);
    var dataCarmin = new DataSelector("tabs-3", "id_data_carmin_platform_url", "id_data_carmin_platform_apikey", "msg_carmin", DATA_CARMIN);

     // Process URL once the user is done typing
    var typingTimer;
    var doneTypingInterval = 3000;
    var $input = $('#id_data_url');
    $('#id_data_url').keyup(function(){
        clearTimeout(typingTimer);
        dataURL.reset();
        if ($('#id_data_url').val()) {
            typingTimer = setTimeout(dataURL.processData, doneTypingInterval);
        }
        
    });
    $('#id_data_url').blur(function(){
        clearTimeout(typingTimer);
        if ($('#id_data_url').val()) {
            dataURL.processData();
        }
    });
            
    // Process file upon selection
    $(id_data_file).change(function() {
        dataFile.processData();
        let fileName = $(this).val().split('\\').pop(); 
        $(this).next('.custom-file-control').addClass("selected").html(fileName);         
    });
    
    // Process CARMIN url when:
        // (1) The user is done typing after X amount of time in the currently selected field
        // (2) The other field has data in it
    function isCarminInputReady() {
        if ($('#id_data_carmin_platform_url').val() && $('#id_data_carmin_platform_apikey').val()) {
            return true;
        }
        return false;
    }
    var typingTimer_carmin;
    $('#id_data_carmin_platform_url').keyup(function(){
        clearTimeout(typingTimer_carmin);
        dataCarmin.reset();
        if (isCarminInputReady()) {
            typingTimer_carmin = setTimeout(dataCarmin.processData, doneTypingInterval);
        }
    });
    $('#id_data_carmin_platform_apikey').keyup(function(){
        clearTimeout(typingTimer_carmin);
        dataCarmin.reset();
        if (isCarminInputReady()) {
            typingTimer_carmin = setTimeout(dataCarmin.processData, doneTypingInterval);
        }
    });
        // (1) The current field has been defocused and has data in it
        // (2) The other field has data in it
    $('#id_data_carmin_platform_url').blur(function(){
        clearTimeout(typingTimer_carmin);
        if (isCarminInputReady()) {
            dataCarmin.processData();
        }
    });
    $('#id_data_carmin_platform_apikey').blur(function(){
        clearTimeout(typingTimer_carmin);
        if (isCarminInputReady()) {
            dataCarmin.processData();
        }
    });



    
    function getActiveTab() {
        var ul = document.getElementById("tabs");
        var items = ul.getElementsByTagName("a")
        for (var i = 0; i < items.length; ++i) {
            if (items[i].className.includes("active")) {
                return items[i].id;
            }
        }
    }

    $("#form1").submit( function(eventObj) {
        
        var activeTab = getActiveTab();
        if (activeTab == "tab-web") {
        
            return dataURL.submit();
        }
        if (activeTab == "tab-computer") {
            return dataFile.submit();
        }
        if (activeTab == "tab-carmin") {
            return dataCarmin.submit();
        }

        
    });
    
    
    $('#tabs a').click(function (e) {
      e.preventDefault()
      $(this).tab('show')
    });
        
});


</script>

<div class="table-container">
    {% block table %}
        <table {% if table.attrs %} {{ table.attrs.as_html }}{% else %}class="table table-striped"{% endif %}>
            {% block table.thead %}
            {% if table.show_header %}
                <thead>
                <tr>
                {% for column in table.columns %}
                    {% if column.orderable %}
                        <th {{ column.attrs.th.as_html }}><a href="{% querystring table.prefixed_order_by_field=column.order_by_alias.next %}">{{ column.header }}</a></th>
                    {% else %}
                        <th {{ column.attrs.th.as_html }}>{{ column.header }}</th>
                    {% endif %}
                {% endfor %}
                </tr>
                </thead>
            {% endif %}
            {% endblock table.thead %}
            {% block table.tbody %}
                <tbody>
                {% for row in table.page.object_list|default:table.rows %} {# support pagination #}
                    {% block table.tbody.row %}
					
                    <tr {{ row.attrs.as_html }}>
                        {% for column, cell in row.items %}
                            <td {{ column.attrs.td.as_html }}>{% if column.localize == None %}{{ cell }}{% else %}{% if column.localize %}{{ cell|localize }}{% else %}{{ cell|unlocalize }}{% endif %}{% endif %}</td>
                        {% endfor %}
                    </tr>
					<tr class="collapse " id="test-panel-{{ row.record.id }}" ><td colspan="6">
                            {% if row.record.error_message == "" %}
                            <div class="">
                            <table class="table">
                                  <tbody>
                                       {% for test in row.record.data %}
                                          {% if test.execution_status == 0 %}
                                          <tr class="" data-toggle="collapse" data-target="#assertion-panel-{{ test.id }}">
                                          {% endif %}

                                          {% if test.execution_status == 1 %}
                                          <tr class="table-success" data-toggle="collapse" data-target="#assertion-panel-{{ test.id }}">
                                          {% endif %}

                                          {% if test.execution_status == 2 %}
                                          <tr class="table-danger" data-toggle="collapse" data-target="#assertion-panel-{{ test.id }}">
                                          {% endif %}

                                                  <td> {{ test.test_name }} </td>
                                                  <td> <samp>{{ test.evaluated_invocation }}</samp> </td>
                                                  <td> <a data-toggle="collapse" data-target="#assertion-panel-{{ test.id }}">View more</a></td>
                                          </tr>
            
                                          <tr class="collapse " id="assertion-panel-{{ test.id }}"><td colspan="6"> 
                                            <div id="accordion">
                                              <div class="card">
                                                <div class="card-header" id="headingOne">
                                                  <h5 class="mb-0">
                                                    <button class="btn btn-link" data-toggle="collapse" data-target="#{{ test.id }}-collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                                      View console logs
                                                    </button>
                                                  </h5>
                                                </div>

                                                <div id="{{ test.id }}-collapseOne" class="collapse show" aria-labelledby="headingOne" data-parent="#accordion">
                                                  <div class="card-body text-white bg-secondary" style="width: 100%;background-color: #20282c;">
                                                    <pre><code><p class="text-white">{{ test.code }}</p><pre></code>
                                                  </div>
                                                </div>
                                              </div>
                                              <div class="card">
                                                <div class="card-header" id="headingTwo">
                                                  <h5 class="mb-0">
                                                    <button class="btn btn-link collapsed" data-toggle="collapse" data-target="#{{ test.id }}-collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                                      View assertions
                                                    </button>
                                                  </h5>
                                                </div>
                                                <div id="{{ test.id }}-collapseTwo" class="collapse" aria-labelledby="headingTwo" data-parent="#accordion">
                                                  <div class="card-body">

                                                    {% for assertion in test.data %}
                                                    <div class="row">
                                                        <div class="col-sm-4"> {{ assertion.type }} </div>
                                                        <div class="col-sm-4"> {{ assertion.operand1 }} </div>
                                                        <div class="col-sm-4"> {{ assertion.operand2 }} </div>
                                                    </div>
                                                    {% endfor %}      
                                                  
                                                  
                                                  </div>
                                                </div>
                                              </div>
                                            </div>
                                          

                                          </tr>
                                       {% endfor %}
                                  </tbody>                                 
                            </table>
                            </div>
                            {% else %}
                          <div class="card-body text-white bg-secondary" style="width: 100%;background-color: #20282c;">
                            <pre><code><p class="text-white">{{ row.record.error_message }}</p><pre></code>
                          </div>
                            {% endif %}
                            
                    </td></tr>
					
                    {% endblock table.tbody.row %}
                    {% empty %}
                    {% if table.empty_text %}
                    {% block table.tbody.empty_text %}
                        <tr><td colspan="{{ table.columns|length }}">{{ table.empty_text }}</td></tr>
                    {% endblock table.tbody.empty_text %}
                    {% endif %}
                {% endfor %}
                </tbody>
            {% endblock table.tbody %}
            {% block table.tfoot %}
            {% if table.has_footer %}
            <tfoot>
                <tr>
                {% for column in table.columns %}
                    <td {{ column.attrs.tf.as_html }}>{{ column.footer }}</td>
                {% endfor %}
                </tr>
            </tfoot>
            {% endif %}
            {% endblock table.tfoot %}
        </table>
    {% endblock table %}

    {% if table.page and table.paginator.num_pages > 1 %}
        {% block pagination %}
        <ul class="pager list-inline">
            {% if table.page.has_previous %}
                {% block pagination.previous %}
                <li class="previous">
                    <a href="{% querystring table.prefixed_page_field=table.page.previous_page_number %}" class="btn btn-default"><span aria-hidden="true">&larr;</span> {% trans 'previous' %}</a>
                </li>
                {% endblock pagination.previous %}
            {% endif %}

            {% if table.page.has_previous or table.page.has_next %}
                {% block pagination.current %}
                    <li class="cardinality">
                        <small>{% blocktrans with table.page.number as current and table.paginator.num_pages as total %}Page {{ current }} of {{ total }}{% endblocktrans %}</small>
                    </li>
                {% endblock pagination.current %}
            {% endif %}

            {% if table.page.has_next %}
                {% block pagination.next %}
                <li class="next">
                    <a href="{% querystring table.prefixed_page_field=table.page.next_page_number %}" class="btn btn-default">{% trans 'next' %} <span aria-hidden="true">&rarr;</span></a>
                </li>
                {% endblock pagination.next %}
            {% endif %}
        </ul>
        {% endblock pagination %}
    {% endif %}
</div>
{% endblock table-wrapper %}
